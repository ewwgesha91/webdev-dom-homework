<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div id="preloader">Загрузка страницы комментариев...</div>
      <ul id = 'comment' class="comments">
      </ul>
      <div id="add-form" class="add-form">
        <input id = 'name-input'
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea id = 'text-input'
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button">Написать</button>
        </div>
      </div>
      <div id="loader">Комментарий добавляется...</div>
    </div>
  </body>
  <style>
    .error {
      background-color: red;
    }
  </style>
  <script>
    "use strict";
    const nameInput = document.getElementById('name-input');
    const textInput = document.getElementById('text-input');
    const addButton = document.getElementById('add-button');
    const comment = document.getElementById('comment');
    const preloader = document.getElementById('preloader');
    const addForm = document.getElementById('add-form');
    const loader = document.getElementById('loader');
    const currentDate = (date) => {
      let day = String(date.getDate()).padStart(2, '0');
      let month = String(date.getMonth() + 1).padStart(2, '0');
      let year = String(date.getFullYear() - 2000);
      let hour = String(date.getHours()).padStart(2, '0');
      let minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}.${month}.${year} ${hour}:${minutes}`;
    };
    
    loader.style.display = 'none';

    const getComments = () => {
      return fetch("https://wedev-api.sky.pro/api/v1/evgeniia-lomakina/comments", {
      method: "GET",
      }).then((response) => {
        if (response.status === 500) {
          throw new Error('Сервер сломался');
        } else {
          return response.json();
        }
      }).then((responseData) => {
          const appComments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date: new Date(comment.date),
              text: comment.text,
              likesCounter: comment.likes,
              isLiked: comment.isLiked,
            };
          });
          comments = appComments;
          renderComments();
          quoteComment();
          preloader.style.display = 'none';
        })
        .catch((error) => {
           if (error.message === 'Сервер сломался') {
            alert('Сервер сломался, попробуйте позже.');
          };
          if (error.message === 'Failed to fetch') {
            alert('Проблемы с соединением, попробуйте позже.');
          }
          console.warn(error);
        });
    }; 
    getComments();

    let comments = [ ];

    const initLikesListeners = () => {
      const likeButtons = document.querySelectorAll('.like-button');
      for (const likeButton of likeButtons) {
        likeButton.addEventListener('click', (event) => {
          event.stopPropagation();
          const index = likeButton.dataset.index;
          comments[index].likesCounter += comments[index].isLiked ? -1 : +1;
          comments[index].isLiked = !comments[index].isLiked;
          renderComments();
          quoteComment();
        })
      }
    }

    const renderComments = () => {
      comment.innerHTML = comments.map((comment, index) => {
        return `<li class="comment" data-index="${index}">
          <div class="comment-header">
            <div id ='name-input'>${comment.name}</div>
            <div>${currentDate(comment.date)}</div>
          </div>
          <div class="comment-body">
            <div id='text-input' class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likesCounter}</span>
              <button data-index='${index}' class="like-button ${comment.isLiked ? "-active-like" : ""}"></button>
            </div>
          </div>
        </li>`
      }).join('');
      initLikesListeners();
    }

    const quoteComment = () => {
        const commentElements = document.querySelectorAll(".comment");
        for (const comment of commentElements) {
          comment.addEventListener('click', () => {
          const index = comment.dataset.index;
          textInput.value = `${comments[index].name}: \n${comments[index].text}\n`;
          })
        }
      }

    renderComments(); 
    quoteComment();
    
    addButton.addEventListener('click', () => {
      nameInput.classList.remove('error');
      textInput.classList.remove('error');
      if (nameInput.value.trim() === '' && textInput.value.trim() === '') {
        nameInput.classList.add('error');
        textInput.classList.add('error');
        return;
      } else if (nameInput.value.trim() === '') {
        nameInput.classList.add('error');
        return;
      } else if (textInput.value.trim() === '') {
        textInput.classList.add('error');
        return;
      }
      
      addForm.style.display = 'none';
      loader.style.display = 'block';

      return fetch("https://wedev-api.sky.pro/api/v1/evgeniia-lomakina/comments", 
        {method: "POST",
          body: JSON.stringify({
          name: nameInput.value.replaceAll('>', '&gt;').replaceAll('<', '&lt;'),
          text: textInput.value.replaceAll('>', '&gt;').replaceAll('<', '&lt;'),
          forceError: true,
        }),
      }).then((response) => {
        if (response.status === 400) {
          throw new Error('Некорректный запрос');
        } else if (response.status === 500) {
          throw new Error('Сервер сломался');
        } else {
          return getComments();
        }
        })
        .then((responseData) => {
          loader.style.display = 'none';
          addForm.style.display = 'flex';
          nameInput.value = '';
          textInput.value = '';
        })
        .catch((error) => {
          if (error.message === 'Некорректный запрос') {
            alert('Имя и комментарий должны быть не короче 3 символов.');
          };
           if (error.message === 'Сервер сломался') {
            alert('Сервер сломался, попробуйте позже.');
          };
          if (error.message === 'Failed to fetch') {
            alert('Проблемы с соединением, попробуйте позже.');
          }
          loader.style.display = 'none';
          addForm.style.display = 'flex';
          console.warn(error);
        });
    });
    renderComments();
    quoteComment();
  </script>
</html>